<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glisser-Déposer pour Table</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/result.css') }}">
  
</head>
<body>
    <div class="header-secondary">
        <div class="nav-links">
            <a href="{{ url_for('list_regions') }}">Statistiques</a>
            <a href="{{ url_for('search_indicators') }}">Requête</a>
            <a href="#{{ url_for('domaines') }}">Domaines</a>
            <a href="#connexion">Aide</a>
        </div>
    </div>
    <h3 class="titre-indicateur">Données pour {{indicateur2.capitalize()}}</h3>

<div class="parent-frame">
<div class="container">
    <!-- Liste des colonnes à glisser -->
    <div>
        <h3>Niveau désagrégation</h3>
        {% for colonne in colonne_valable %}
            <div class="draggable-item" data-column="{{ colonne }}" draggable="true">{{ colonne.capitalize() }}</div>
        {% endfor %}
        <!-- Ajoute ici d'autres colonnes selon ton besoin -->
    </div>

   <!-- Zone contenant le dépôt et les filtres -->
<div id="depot-filter-container">
    <!-- Zone de dépôt -->
    <div>
        <h3>Zone de dépôt</h3>
        <div id="droppable-area">
            <span id="placeholder-text">Glissez et déposez les niveaux de désagrégation ici</span>
        </div>
    </div>

    <!-- Zone des filtres -->
    <div>
        <h3>Zone de filtre</h3>
        <div id="filter-container">
            <!-- Les filtres seront générés ici -->
        </div>
    </div>
</div>
</div>
<!-- Conteneur pour afficher le tableau généré -->
<div id="table-container"></div>
</div>

<script>
    // Variables pour gérer le glisser-déposer
    const draggableItems = document.querySelectorAll('.draggable-item');
    const droppableArea = document.getElementById('droppable-area');
    const tableContainer = document.getElementById('table-container');
    const filterContainer = document.getElementById('filter-container');
    let selectedColumns = [];
    let tableData = [];

    // Ajouter les gestionnaires d'événements de glisser-déposer
    draggableItems.forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
    });

    droppableArea.addEventListener('dragover', handleDragOver);
    droppableArea.addEventListener('drop', handleDrop);

    // Événements de glisser-déposer
    function handleDragStart(event) {
        event.dataTransfer.setData('text/plain', event.target.dataset.column);
        event.target.classList.add('dragging');
    }

    function handleDragOver(event) {
        event.preventDefault();
        event.target.classList.add('hovered');
    }

    function handleDrop(event) {
        event.preventDefault();
        const column = event.dataTransfer.getData('text/plain');

        if (!selectedColumns.includes(column)) {
            selectedColumns.push(column);

            // Créer un nouvel élément dans la zone de dépôt
            const newItem = document.createElement('div');
            newItem.classList.add('draggable-item');
            newItem.textContent = column;
            newItem.setAttribute('draggable', 'true');
            newItem.setAttribute('data-column', column);
            newItem.addEventListener('dragstart', handleDragStart);

            // Ajouter un événement de clic pour retirer l'élément
            newItem.addEventListener('click', function () {
                droppableArea.removeChild(newItem);
                selectedColumns = selectedColumns.filter(col => col !== column);
                sendColumnsToServer();
            });

            droppableArea.appendChild(newItem);
        }

        // Cacher le texte placeholder si un élément est déposé
        const placeholder = document.getElementById('placeholder-text');
        if (placeholder) {
            placeholder.style.display = 'none';
        }

        sendColumnsToServer();
    }

    // Vérifie si la zone de dépôt est vide et affiche le placeholder
    function checkDroppableArea() {
        if (droppableArea.children.length === 0) {
            const placeholder = document.getElementById('placeholder-text');
            placeholder.style.display = 'block';
        }
    }

    // Fonction pour envoyer les colonnes sélectionnées au serveur Flask
    function sendColumnsToServer() {
        fetch('/process_columns', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ columns: selectedColumns })
        })
        .then(response => response.json())
        .then(data => {
            tableData = data;
            generateTable(tableData);
            generateFilters();
        })
        .catch(error => {
            console.error('Erreur:', error);
        });
    }

    // Fonction pour générer les filtres
    function generateFilters() {
        filterContainer.innerHTML = '';

        selectedColumns.forEach(col => {
            const label = document.createElement('label');
            label.textContent = `Filtrer par ${col}:`;
            const select = document.createElement('select');
            select.setAttribute('data-column', col);

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Tous';
            select.appendChild(defaultOption);

            const uniqueValues = [...new Set(tableData.map(row => row[col]))];

            uniqueValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            });

            select.addEventListener('change', applyFilters);

            filterContainer.appendChild(label);
            filterContainer.appendChild(select);
        });
    }

    // Fonction pour appliquer les filtres
    function applyFilters() {
        let filteredData = tableData;

        const selects = filterContainer.querySelectorAll('select');
        selects.forEach(select => {
            const column = select.getAttribute('data-column');
            const value = select.value;
            if (value) {
                filteredData = filteredData.filter(row => row[column] == value);
            }
        });

        generateTable(filteredData);
    }

    // Fonction pour générer le tableau
    function generateTable(data) {
        tableContainer.innerHTML = '';

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');

        const headerRow = document.createElement('tr');
        selectedColumns.forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;
            headerRow.appendChild(th);
        });
        const totalTh = document.createElement('th');
        totalTh.textContent = 'Valeur';
        headerRow.appendChild(totalTh);
        thead.appendChild(headerRow);

        data.forEach(row => {
            const tr = document.createElement('tr');
            selectedColumns.forEach(col => {
                const td = document.createElement('td');
                td.textContent = row[col] || 'N/A';
                tr.appendChild(td);
            });
            const totalTd = document.createElement('td');
            totalTd.textContent = row.valeur;
            tr.appendChild(totalTd);
            tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
        tableContainer.appendChild(table);
    }
</script>


</body>
</html>