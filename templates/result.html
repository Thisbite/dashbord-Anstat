<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glisser-Déposer pour Table</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/result.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  
</head>
<body>
    <div class="header-secondary">
        <div class="nav-links">
            <a href="{{ url_for('list_regions') }}">Statistiques</a>
            <a href="{{ url_for('search_indicators') }}">Requête</a>
            <a href="#">A propos</a>
            <a href="#connexion">Aide</a>
        </div>
    </div>
    <h3 class="titre-indicateur">Données pour {{indicateur2.capitalize()}}</h3>

<div class="parent-frame">
    <!-- Conteneur pour afficher les boutons de téléchargement -->
<div class="download-buttons">
    <button id="download-xlsx">Télécharger en XLSX</button>
    <button id="download-csv">Télécharger en CSV</button>
</div>

    <!-- deux boutons créer en js pour telecharger le tableau en xlsx et csv-->
<div class="container">
    <!-- Liste des colonnes à glisser -->
    <div>
        <h3>Niveau désagrégation</h3>
        {% for colonne in colonne_valable %}
            <div class="draggable-item" data-column="{{ colonne }}" draggable="true">{{ colonne.capitalize() }}</div>
        {% endfor %}
        <!-- Ajoute ici d'autres colonnes selon ton besoin -->
    </div>

   <!-- Zone contenant le dépôt et les filtres -->
<div id="depot-filter-container">
    <!-- Zone de dépôt -->
    <div>
        <h3>Zone de dépôt</h3>
        <div id="droppable-area">
            <span id="placeholder-text">Glissez et déposez les niveaux de désagrégation ici</span>
        </div>
    </div>

    <!-- Zone des filtres -->
    <div>
        <h3>Zone de filtre</h3>
        <div id="filter-container">
            <!-- Les filtres seront générés ici -->
        </div>
    </div>
</div>
</div>
<!-- Conteneur pour afficher le tableau généré -->
<div id="table-container"></div>
</div>

<script>
    // Variables pour gérer le glisser-déposer
    const draggableItems = document.querySelectorAll('.draggable-item');
    const droppableArea = document.getElementById('droppable-area');
    const tableContainer = document.getElementById('table-container');
    const filterContainer = document.getElementById('filter-container');
    let selectedColumns = [];
    let tableData = [];
    let filteredTableData = [];  // Nouvelle variable pour stocker les données filtrées

    // Ajouter les gestionnaires d'événements de glisser-déposer
    draggableItems.forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
    });

    droppableArea.addEventListener('dragover', handleDragOver);
    droppableArea.addEventListener('drop', handleDrop);

    // Événements de glisser-déposer
    function handleDragStart(event) {
        event.dataTransfer.setData('text/plain', event.target.dataset.column);
        event.target.classList.add('dragging');
    }

    function handleDragOver(event) {
        event.preventDefault();
        event.target.classList.add('hovered');
    }

    function handleDrop(event) {
        event.preventDefault();
        const column = event.dataTransfer.getData('text/plain');

        if (!selectedColumns.includes(column)) {
            selectedColumns.push(column);

            // Créer un nouvel élément dans la zone de dépôt
            const newItem = document.createElement('div');
            newItem.classList.add('draggable-item');
            newItem.textContent = column;
            newItem.setAttribute('draggable', 'true');
            newItem.setAttribute('data-column', column);
            newItem.addEventListener('dragstart', handleDragStart);

            // Ajouter un événement de clic pour retirer l'élément
            newItem.addEventListener('click', function () {
                droppableArea.removeChild(newItem);
                selectedColumns = selectedColumns.filter(col => col !== column);
                sendColumnsToServer();
            });

            droppableArea.appendChild(newItem);
        }

        // Cacher le texte placeholder si un élément est déposé
        const placeholder = document.getElementById('placeholder-text');
        if (placeholder) {
            placeholder.style.display = 'none';
        }

        sendColumnsToServer();
    }

    // Vérifie si la zone de dépôt est vide et affiche le placeholder
    function checkDroppableArea() {
        if (droppableArea.children.length === 0) {
            const placeholder = document.getElementById('placeholder-text');
            placeholder.style.display = 'block';
        }
    }

    // Fonction pour envoyer les colonnes sélectionnées au serveur Flask
    function sendColumnsToServer() {
        fetch('/process_columns', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ columns: selectedColumns })
        })
        .then(response => response.json())
        .then(data => {
            tableData = data;
            filteredTableData = data; // Initialisation de filteredTableData
            generateTable(filteredTableData);
            generateFilters();
        })
        .catch(error => {
            console.error('Erreur:', error);
        });
    }

    // Fonction pour générer les filtres
    function generateFilters() {
        filterContainer.innerHTML = '';

        selectedColumns.forEach(col => {
            const label = document.createElement('label');
            label.textContent = `Filtrer par ${col}:`;
            const select = document.createElement('select');
            select.setAttribute('data-column', col);

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Tous';
            select.appendChild(defaultOption);

            const uniqueValues = [...new Set(tableData.map(row => row[col]))];

            uniqueValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            });

            select.addEventListener('change', applyFilters);

            filterContainer.appendChild(label);
            filterContainer.appendChild(select);
        });
    }

    // Fonction pour appliquer les filtres
    function applyFilters() {
        filteredTableData = tableData;  // Commencez avec toutes les données

        const selects = filterContainer.querySelectorAll('select');
        selects.forEach(select => {
            const column = select.getAttribute('data-column');
            const value = select.value;
            if (value) {
                filteredTableData = filteredTableData.filter(row => row[column] == value);
            }
        });

        generateTable(filteredTableData);  // Utilisez les données filtrées pour générer le tableau
    }

    // Fonction pour générer le tableau
    function generateTable(data) {
        tableContainer.innerHTML = '';

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');

        const headerRow = document.createElement('tr');
        selectedColumns.forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;
            headerRow.appendChild(th);
        });
        const totalTh = document.createElement('th');
        totalTh.textContent = 'Valeur';
        headerRow.appendChild(totalTh);
        thead.appendChild(headerRow);

        data.forEach(row => {
            const tr = document.createElement('tr');
            selectedColumns.forEach(col => {
                const td = document.createElement('td');
                td.textContent = row[col] || 'N/A';
                tr.appendChild(td);
            });
            const totalTd = document.createElement('td');
            totalTd.textContent = row.valeur;
            tr.appendChild(totalTd);
            tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
        tableContainer.appendChild(table);
    }
    // Fonction pour convertir les données en CSV en tenant compte des filtres
    function convertToCSV(data) {
        const header = selectedColumns.join(',') + ',Valeur\n';
        const rows = data.map(row => {
            const rowData = selectedColumns.map(col => row[col] || 'N/A').join(',');
            return `${rowData},${row.valeur}`;
        }).join('\n');
        return header + rows;
    }
    // Fonction pour convertir les données en XLSX en tenant compte des filtres
    function downloadXLSX() {
        const workbook = XLSX.utils.book_new();
        const worksheetData = [selectedColumns.concat('Valeur')];

        filteredTableData.forEach(row => {
            const rowData = selectedColumns.map(col => row[col] || 'N/A').concat(row.valeur);
            worksheetData.push(rowData);
        });

        const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Tableau');

        XLSX.writeFile(workbook, 'tableau.xlsx');
    }

    // Fonction pour télécharger le CSV en tenant compte des filtres
    function downloadCSV() {
        const csv = convertToCSV(filteredTableData);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'tableau.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Ajoutez les événements de clic pour les boutons de téléchargement
    document.getElementById('download-xlsx').addEventListener('click', downloadXLSX);
    document.getElementById('download-csv').addEventListener('click', downloadCSV);

</script>



</body>
</html>