<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Requete sur indicateur</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/search_indicateur.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha384-k6RqeWeci5ZR/Lv4MR0sA0FfDOMoAm5Wc8pN4dZQoGNSx+Lr5mICwL7F45B5cOa" crossorigin="anonymous">
</head>
<body>

    <div class="header-secondary">
        <div class="nav-links">
            <a href="{{ url_for('list_regions') }}">Statistiques</a>
            <a href="{{ url_for('search_indicators') }}">Requête</a>
            <a href="#">A propos</a>
            <a href="#connexion">Aide</a>
        </div>

        <!-- Formulaire de recherche -->
        <div class="search-bar">
            <!--Utilisation de recherche
     
            -->
            <form method="POST" action="{{ url_for('search') }}">
                <input type="text" name="query" placeholder="Recherche dans la base" required>
                <button type="submit">Rechercher</button>
            </form>
        </div>
    </div>
  <div class="container mt-5">
   
    <div class="row">
      <!-- Colonne 1: Liste des Domaines -->
      <div class="col-md-4 sidebar">
        <h5>Domaines</h5>
        <ul id="domaines" class="list-group">
          <!-- Les domaines seront générés dynamiquement ici -->
        </ul>
    </div>

      <!-- Colonne 2: Liste des Thématiques -->
      <div class="col-md-4 main-content">
        <h5>Thématiques</h5>
        <ul id="thematiques" class="list-group">
          <!-- Les thématiques apparaîtront ici dynamiquement -->
        </ul>
      </div>

      <!-- Colonne 3: Liste des Indicateurs -->
      <div class="col-md-4 indicators-list main-content">
        <h5>Indicateurs</h5>
        <ul id="indicateurs" class="list-group">
          <!-- Les indicateurs apparaîtront ici dynamiquement -->
        </ul>
      </div>
    </div>
  </div>

  <script>
    let domaines = {};  // Déclaration de l'objet domaines au niveau global

    // Fonction pour récupérer les données depuis Flask
    function fetchData() {
        fetch('/get_data2')
            .then(response => response.json())
            .then(data => {
                // Remplir l'objet domaines avec les données récupérées
                Object.keys(data).forEach(key => {
                    const [domaine, thematique] = key.split(', ');
                    if (!domaines[domaine]) {
                        domaines[domaine] = { thematiques: {} };
                    }
                    domaines[domaine].thematiques[thematique] = data[key];
                });

                // Appeler la fonction pour afficher la liste des domaines
                displayDomaines();

                // Charger automatiquement les thématiques du premier domaine si nécessaire
                const firstDomaine = Object.keys(domaines)[0];
                if (firstDomaine) {
                    selectDomaine(firstDomaine);  // Charger automatiquement les thématiques du premier domaine
                }
            })
            .catch(error => {
                console.error('Erreur lors de la récupération des données:', error);
            });
    }

    // Fonction pour afficher les domaines dans la liste
    function displayDomaines() {
        const domainesList = document.getElementById('domaines');
        domainesList.innerHTML = '';  // Réinitialiser la liste des domaines

        // Parcourir tous les domaines et créer des éléments de liste dynamiques
        Object.keys(domaines).forEach(domaine => {
            const li = document.createElement('li');
            li.classList.add('list-group-item');
            li.onclick = function () {
                selectDomaine(domaine);  // Appeler la fonction de sélection de domaine
            };

            // Ajouter une icône et le texte du domaine (vous pouvez ajuster selon vos besoins)
            li.innerHTML = `<i class="fas fa-folder"></i> ${domaine.charAt(0).toUpperCase() + domaine.slice(1).replace(/_/g, ' ')}`;
            
            // Ajouter l'élément de liste au conteneur
            domainesList.appendChild(li);
        });
    }

    // Appeler la fonction pour récupérer et afficher les données dès le chargement de la page
    document.addEventListener('DOMContentLoaded', function () {
        fetchData();  // Appel de la fonction de récupération des données
    });

    // Fonction pour afficher les thématiques en fonction du domaine sélectionné
    function selectDomaine(domaine) {
      const thematiquesList = document.getElementById('thematiques');
      const indicateursList = document.getElementById('indicateurs');
      thematiquesList.innerHTML = ''; // Réinitialiser la liste des thématiques
      indicateursList.innerHTML = ''; // Réinitialiser la liste des indicateurs

      // Vérifier si le domaine existe dans les données
      if (!domaines[domaine]) {
          console.error(`Le domaine ${domaine} n'existe pas.`);
          return;
      }

      // Ajouter les thématiques du domaine sélectionné
      Object.keys(domaines[domaine].thematiques).forEach((thematique) => {
        const li = document.createElement('li');
        li.classList.add('list-group-item');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.classList.add('form-check-input');
        checkbox.id = thematique;
        checkbox.onchange = function () {
          toggleIndicateurs(domaine, thematique, checkbox.checked);
        };
        const label = document.createElement('label');
        label.classList.add('checkbox-label');
        label.setAttribute('for', thematique);
        label.innerHTML = thematique.charAt(0).toUpperCase() + thematique.slice(1);

        li.appendChild(checkbox);
        li.appendChild(label);
        thematiquesList.appendChild(li);
      });
    }

    // Fonction pour afficher ou masquer les indicateurs en fonction des thématiques cochées
    function toggleIndicateurs(domaine, thematique, isChecked) {
      const indicateursList = document.getElementById('indicateurs');
      if (isChecked) {
        domaines[domaine].thematiques[thematique].forEach((indicateur) => {
          const li = document.createElement('li');
          li.classList.add('list-group-item');
          li.id = `indicateur-${indicateur.replace(/\s+/g, '-')}`;

          // Créer le lien pour l'indicateur
          const a = document.createElement('a');
          a.href = `#`;  // Remplacer par l'URL réelle si nécessaire
          a.innerHTML = indicateur;
          a.classList.add('indicateur-link');
          li.appendChild(a);

          indicateursList.appendChild(li);
          // Ajouter un événement 'click' pour capturer l'indicateur cliqué et rediriger
          a.onclick = function (event) {
            event.preventDefault();  // Empêcher le comportement par défaut de l'élément <a>
            searchIndicatorInElastic(indicateur);  // Appeler une fonction pour traiter la recherche
          };
        });
      } else {
        // Supprimer les indicateurs liés à la thématique décochée
        domaines[domaine].thematiques[thematique].forEach((indicateur) => {
          const li = document.getElementById(`indicateur-${indicateur.replace(/\s+/g, '-')}`);
          if (li) {
            indicateursList.removeChild(li);
          }
        });
      }
    }
    // Fonction pour rediriger vers la route Flask avec l'indicateur sélectionné
function searchIndicatorInElastic(indicateur) {
  // Encodez l'indicateur pour éviter des problèmes avec les caractères spéciaux
  const encodedIndicateur = encodeURIComponent(indicateur);
  
  // Rediriger vers la route Flask en passant l'indicateur dans l'URL
  window.location.href = `/search_indicators2/${encodedIndicateur}`;
}

</script>


</body>
</html>
